# /code-review - 代码审查

## 描述

对实现的代码进行质量审查，检查是否符合需求设计、代码质量标准和技术规范。通常在任务实现完成后自动触发。

## 使用方法

```
/code-review                    # 审查最新实现的代码
/code-review TASK-001           # 审查特定任务的代码
/code-review --full             # 全面审查整个工作流代码
```

## 执行规范

### 前置条件

1. 检查工作流目录是否有代码修改
2. 确保所有代码都已提交到 Git
3. 如果 Task.md 中有微任务标记为 `in-progress` 或 `completed`，审查相关代码

### 审查维度

#### 1. 需求符合度 (Requirement Compliance)

```
审查内容:
☑ 实现了所有需求的功能点
☑ 没有超范围的额外功能
☑ 满足了所有验收标准
☑ 考虑了非功能性需求（性能、安全、可靠性）

示例:
需求: 支持邮箱和用户名登录
实现检查:
  ✓ 邮箱登录已实现
  ✓ 用户名登录已实现
  ✓ 两种方式都返回 JWT Token
  ✓ 验收标准: 5 次失败后锁定 15 分钟 ✓
```

#### 2. 设计一致性 (Design Consistency)

```
审查内容:
☑ 代码结构遵循了 Design.md 中的架构设计
☑ 使用了设计中指定的技术方案
☑ 接口定义与设计相符
☑ 数据模型与设计相符

示例:
设计: 使用 JWT Token + bcrypt 密码加密
实现检查:
  ✓ 密码使用 bcrypt 加密，工作因子 10
  ✓ JWT Token 使用 HS256 算法
  ✓ Token 包含用户 ID 和过期时间
  ✓ 遵循 RFC 7519 标准
```

#### 3. 代码质量 (Code Quality)

```
审查内容:
☑ 命名规范: 变量、函数、类名清晰有意义
☑ 代码结构: 模块划分合理，高内聚低耦合
☑ 错误处理: 异常情况都有适当处理
☑ 安全性: 没有 SQL 注入、XSS、跨越漏洞等
☑ 性能: 没有明显的性能问题或瓶颈
☑ 可读性: 代码清晰易懂，适当有注释

审查标准:
  ✓ 代码行数合理，单函数不超过 50 行
  ✓ 圈复杂度低（<10）
  ✓ 没有重复代码（DRY 原则）
  ✓ 使用了适当的设计模式
```

#### 4. 测试覆盖 (Test Coverage)

```
审查内容:
☑ 单元测试覆盖率 >= 80%
☑ 关键路径有集成测试
☑ 错误情况都有测试
☑ 边界条件有测试

审查指标:
  覆盖率: 95% (高)
  单元测试: 12 个通过
  集成测试: 5 个通过
  失败测试: 0 个
```

#### 5. 文档完整性 (Documentation)

```
审查内容:
☑ 函数/类有适当注释
☑ 复杂逻辑有解释
☑ API 接口有说明
☑ 变更日志已更新

示例:
/**
 * 验证用户密码
 * @param {string} password - 输入的密码
 * @param {string} hash - 数据库中的 bcrypt 哈希
 * @returns {Promise<boolean>} - 密码是否匹配
 * @throws {Error} - 验证失败时抛出
 */
async function verifyPassword(password, hash) { ... }
```

### 输出格式

```
代码审查报告：TASK-001 - 实现用户登录接口

【审查结果】

需求符合度:    ✓ 优秀 (100%)
设计一致性:    ✓ 优秀
代码质量:      ✓ 良好 (有 1 个建议)
测试覆盖:      ✓ 优秀 (96%)
文档完整:      ✓ 优秀

总体评分:      ⭐⭐⭐⭐⭐ (优秀)

【详细结果】

1. 需求符合度 - ✓ 通过
   ✓ 邮箱登录
   ✓ 用户名登录
   ✓ JWT Token 生成
   ✓ 验收标准全部满足

2. 设计一致性 - ✓ 通过
   ✓ 密码加密采用 bcrypt
   ✓ Token 采用 JWT
   ✓ 接口设计相符
   ✓ 架构层次清晰

3. 代码质量 - ⚠ 建议改进
   ✓ 命名规范清晰
   ✓ 错误处理完善
   ✓ 没有安全漏洞
   ⚠ 建议：在登录失败时添加详细日志，便于调试

4. 测试覆盖 - ✓ 优秀
   ✓ 单元测试: 10/10 通过
   ✓ 集成测试: 5/5 通过
   ✓ 覆盖率: 96%
   ✓ 边界条件: 已测试

5. 文档完整 - ✓ 优秀
   ✓ 函数文档完整
   ✓ 复杂逻辑有注释
   ✓ API 文档已更新

【建议】

1. (优先级: 低) 添加登录失败日志
   - 修改位置: src/services/auth.service.ts
   - 内容: 记录失败的用户名和时间，便于安全分析

2. (优先级: 低) 添加性能指标
   - 建议添加登录耗时监控

【下一步】

✓ 代码审查已完成
选择操作:
1. 接受审查 - 标记任务完成
2. 采纳建议 - 继续完善代码
3. 记录为 Bug - 标记待后续处理
```

### 与 Plan 阶段的关系

- **Plan 阶段** (`/dev TASK-001 --plan-only`)：输出的**计划本身**应该被审查
  - 计划的微任务分解是否合理
  - 文件清单是否完整
  - 依赖关系是否正确

- **Execute 阶段** (`/dev TASK-001 --execute`)：完成后的**代码质量**应该被审查
  - 实现是否符合计划
  - 代码质量是否达标
  - 测试覆盖率是否足够

## 相关文档

- `ai-workflow/INSTRUCTIONS.md` - 完整执行规范
- `Requirements.md` - 需求文档
- `Design.md` - 设计文档
- `Task.md` - 任务清单

## 注意事项

- 代码审查不是为了挑剔，而是为了保证质量
- 优秀的建议可以立即采纳，次要建议可以记录为 Bug 后续改进
- 发现的重大问题应该立即修复，不要继续下一个任务
- 代码审查通过后，即可标记任务完成
